<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Generating JavaScript</title>
  <script src="dependencies/blockly_compressed.js"></script>
  <script src="dependencies/blocks_compressed.js"></script>
  <script src="dependencies/python_compressed.js"></script>
  <script src="msg/js/es.js"></script>
  <script src="./modulesMicropython/iot.js"></script>
  <script src="./modulesMicropython/gpio.js"></script>
  <script src="./modulesMicropython/actuadores.js"></script>
  <script src="./modulesMicropython/sensores.js"></script>
  <script src="./modulesMicropython/temporizadores.js"></script>
  <script src="./modulesMicropython/configure.js"></script>
<meta name="viewport" content="width=device-width,
height=520px, initial-scale=1">
<link rel="stylesheet" href="dependencies/w3.css">
<style>
    html, body {
      height: 100%;
      margin: 0;
    }   
    body {
      background-color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }   
    h1 {
      font-weight: normal;
      font-size: 140%;
    }   
    table {
      height: 100%;
      width: 100%;
    }   
    #blocklyArea {
      height: 99%;
      background: #fc9;
      text-align: center;
    }   
</style>

</head>
<body>

<!--style>
.stylePlay {
    display:scroll;
        position:fixed;
        top:0px;
        right:0px;
}</style>
<a class='stylePlay' href='#'><img src='imag/buttonPlay.png' border="0" onclick="sendFromBlocklytoPyb()"/></a>

<style>
.stylePreview {
    display:scroll;
        position:fixed;
        top:0px;
        right:40px;
}</style>
<a class='stylePreview' href='#'><img src='imag/vistaPrevia.png' border="0" onclick="showCode()" /></a>

<style>
.scroll_frame {
    overflow: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling:touch;
    width: 100%;
    height: 100%;
    border: 1px solid #e0e0e0;
}
</style-->

<table>
  <tr>
    <td>
      <div class="w3-btn-group w3-show-inline-block">
	    <button class="w3-btn w3-pale-green" onclick="showCode()">Preview</button>
	    <button class="w3-btn w3-pink" onclick="sendFromBlocklytoPyb()">Play</button>
      </div>
    </td>
  </tr>
  <tr>
    <td id="blocklyArea">
	</td>
  </tr>
</table>


<!--div id="blocklyDiv" class="scroll_frame" ></div-->
<div id="blocklyDiv" style="position: absolute" class="scroll_frame"></div>
  <xml id="toolbox" style="display: none">
    <category name="Lógica" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="Secuencias" colour="120">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="Matemática" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_change">
        <value name="DELTA">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
    </category>
    <category name="Texto" colour="160">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT">
          <shadow type="text"></shadow>
        </value>
      </block>
      <block type="text_length">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_isEmpty">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT"></field>
          </shadow>
        </value>
      </block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">textVariable</field>
          </block>
        </value>
        <value name="FIND">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">textVariable</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">textVariable</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_trim">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_print">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_prompt_ext">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="Listas" colour="260">
      <block type="lists_create_with">
        <mutation items="0"></mutation>
      </block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">listVariable</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">listVariable</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">listVariable</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">listVariable</field>
          </block>
        </value>
      </block>
      <block type="lists_split">
        <value name="DELIM">
          <shadow type="text">
            <field name="TEXT">,</field>
          </shadow>
        </value>
      </block>
      <block type="lists_sort"></block>
    </category>
    <sep></sep>
    <category name="Variables" colour="330" custom="VARIABLE"></category>
    <category name="Funciones" colour="290" custom="PROCEDURE"></category>
    <sep></sep>
    <category id="iot" name="IOT" colour="210">
      <block type='start_iot'></block>
      <block type='task_iot'></block>
      <block type='mqtt_init'>
          <value name='broker'>
          <shadow type="text">
          </shadow>
          </value>
          <value name='port'>
          <shadow type="text">
          </shadow>
          </value>
          <value name='id'>
          <shadow type="text">
          </shadow>
          </value>
      </block>
      <block type='mqtt_pub'></block>
      <block type='mqtt_sub'></block>
      <block type='mqtt_topic'></block>
      <block type='write_thingspeak'></block>
      <block type='field_thingspeak'></block>
    </category>
    <category id="misPines" name="Pines" colour="230">
      <block type='create_pin'></block>
      <block type='gpio_write'></block>
      <block type='gpio_read'></block>
      <block type='library_adc'></block>
      <block type='adc_create'></block>
      <block type='adc_read'></block>
      <block type='library_dac'></block>
    </category>
    <category id="misActuadores" name="Actuadores" colour="27">
      <block type='init_movil'></block>
      <block type='calibration_movil'></block>
      <block type='run_movil'></block>
      <block type='library_servo'></block>
      <block type='start_servo'></block>
      <block type='run_servo'></block>
      <block type='library_stepper'></block>
      <block type='stepper_move'></block>
    </category>
    <category id="misSensores" name="Sensores" colour="120">
      <block type='library_ultrasonido'></block>
      <block type='start_ultrasonido'></block>
      <block type='read_ultrasonido'></block>
      <block type='library_infrarrojo'></block>
      <block type='start_infrarrojo'></block>
      <block type='read_infrarrojo'></block>
    </category>
    <category id="misTemporizadores" name="Temporizadores" colour="65">
      <block type='temporizador_sec'></block>
      <block type='temporizador_millis'></block>
      <block type='temporizador_micro'></block>
    </category>
    <category type='com' name="Comunicación" colour="210">
      <block type='start_config'></block>
      <block type='task_config'></block>
      <block type='wifi_sta'></block>
    </category>
  </xml>

  <script>
	var blocklyArea = document.getElementById('blocklyArea');
	var blocklyDiv = document.getElementById('blocklyDiv');
    var workspace = Blockly.inject('blocklyDiv',
        {media: 'media/',
		toolbox: document.getElementById('toolbox'),
		zoom:
         {controls: true,
          wheel: true,
          startScale: 1.0,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2},
		grid:
         {spacing: 20,
			length: 3,
			colour: '#ccc',
			snap: true},
			trashcan: true});

     var onresize = function(e) {
		// Compute the absolute coordinates and dimensions of blocklyArea.
		var element = blocklyArea;
		var x = 0;
		var y = 0;
		do {
		  x += element.offsetLeft;
		  y += element.offsetTop;
		  element = element.offsetParent;
		} while (element);
		// Position blocklyDiv over blocklyArea.
		blocklyDiv.style.left = x + 'px';
		blocklyDiv.style.top = y + 'px';
		blocklyDiv.style.width =
		blocklyArea.offsetWidth + 'px';
		blocklyDiv.style.height =
		blocklyArea.offsetHeight + 'px';
	};
	window.addEventListener('resize',
	onresize, false);
	onresize();
																					  	
			
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
                               workspace);

    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      var code = 'import pyb\nfrom pyb import Pin\n';
      code += Blockly.Python.workspaceToCode(workspace);
      alert(code);
    }
	function copyCode() {
      // Generate JavaScript code and display it.
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      var code = 'import pyb\nfrom pyb import Pin\n';
      code = code + Blockly.Python.workspaceToCode(workspace);
      return code;
    }
	function sendFromBlocklytoPyb(){
		var data = copyCode();
		parent.iframeConfig.runOnTelnet(data);
		//console.log(data);
	}
  </script>

</body>
</html>
